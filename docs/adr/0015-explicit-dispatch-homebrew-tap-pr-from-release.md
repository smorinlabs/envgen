# 0015: Explicitly dispatch Homebrew tap PR workflow from release pipeline
Date: 2026-02-16
Status: Accepted

## Context

`envgen` publishes GitHub releases in `.github/workflows/release.yml` using
`softprops/action-gh-release` and `secrets.GITHUB_TOKEN`.

The Homebrew tap workflow `.github/workflows/homebrew-tap-pr.yml` previously
listened to `release.published` events. In practice, downstream workflow
triggering from release events generated by `github-actions[bot]` was not
reliable for this pipeline.

Observed outcome: crate release completed, but Homebrew tap sync did not start
unless manually dispatched.

## Decision

Dispatch `.github/workflows/homebrew-tap-pr.yml` explicitly from
`.github/workflows/release.yml` after the `github-release` job succeeds.

Implementation details:

- Add `dispatch-homebrew-tap-pr` job in `release.yml`.
- Use `actions/github-script` and
  `github.rest.actions.createWorkflowDispatch(...)`.
- Pass input `tag=${{ needs.meta.outputs.tag }}`.
- Keep the dispatch job non-blocking via `continue-on-error: true`.
- Keep manual fallback path documented:
  `gh workflow run homebrew-tap-pr.yml -R smorinlabs/envgen -f tag=vX.Y.Z`.

## Consequences

- Homebrew tap sync trigger is deterministic and auditable from the release run.
- Failures in tap workflow dispatch do not block crate release completion.
- Operational debugging is simpler: a single release run contains dispatch
  success/failure signals.
- `homebrew-tap-pr.yml` trigger contract is now `workflow_dispatch` only.

## Alternatives considered

1. Keep `release.published` listener in `homebrew-tap-pr.yml`.
   - Rejected: non-deterministic auto-trigger behavior in this setup.
2. Chain with `workflow_run` from `release.yml`.
   - Rejected: less direct control over input payload (`tag`) and dispatch
     error handling/logging.
3. Publish release with a PAT instead of `GITHUB_TOKEN`.
   - Rejected: introduces additional credential management and wider token
     scope for a problem solved by explicit workflow dispatch.

## References/links

- `/Users/stevemorin/c/envgen/.github/workflows/release.yml`
- `/Users/stevemorin/c/envgen/.github/workflows/homebrew-tap-pr.yml`
- `/Users/stevemorin/c/envgen/RELEASING.md`
