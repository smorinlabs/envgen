name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  check-core:
    name: Core Checks (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: 1.88.0
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: "1.22.x"

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20.x"

      - name: Setup uv
        uses: astral-sh/setup-uv@caf0cab7a618c569241d31dcd442f54681755d39 # v3

      - name: Install core check tooling
        env:
          UV_CACHE_DIR: ${{ github.workspace }}/.uv-cache
          UV_TOOL_DIR: ${{ github.workspace }}/.uv-tools
        run: make install-tools-core

      - name: Run core checks
        env:
          UV_CACHE_DIR: ${{ github.workspace }}/.uv-cache
          UV_TOOL_DIR: ${{ github.workspace }}/.uv-tools
        run: make check-core

  rust-macos:
    name: Rust Checks (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: 1.88.0
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Run Rust checks
        run: make check-rust

  msrv:
    name: MSRV Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Extract MSRV from Cargo.toml
        id: msrv
        run: |
          MSRV=$(grep '^rust-version' Cargo.toml | sed 's/rust-version = "\(.*\)"/\1/')
          echo "version=$MSRV" >> "$GITHUB_OUTPUT"
          echo "Using MSRV: $MSRV"

      - name: Setup Rust (MSRV)
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: ${{ steps.msrv.outputs.version }}

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          cache-all-crates: true

      - name: Install MSRV tooling
        run: make install-tools-msrv

      - name: Run MSRV checks
        run: make check-msrv

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: 1.88.0

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install security tooling
        run: make install-tools-security

      - name: Run security checks
        run: make check-security
