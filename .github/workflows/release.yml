name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.tag.outputs.tag }}

      - name: Validate tag matches Cargo.toml version
        shell: bash
        run: |
          python - <<'PY'
          import os
          import re
          import sys
          try:
            import tomllib  # py3.11+
          except ModuleNotFoundError:
            print("ERROR: Python tomllib not available", file=sys.stderr)
            sys.exit(1)

          tag = os.environ.get("TAG")
          if not tag:
            print("ERROR: TAG env var not set", file=sys.stderr)
            sys.exit(1)
          if not re.match(r"^v\\d+\\.\\d+\\.\\d+.*$", tag):
            print(f"ERROR: tag '{tag}' does not look like vX.Y.Z", file=sys.stderr)
            sys.exit(1)

          with open("Cargo.toml", "rb") as f:
            cargo = tomllib.load(f)
          version = cargo.get("package", {}).get("version")
          if not version:
            print("ERROR: Could not find [package].version in Cargo.toml", file=sys.stderr)
            sys.exit(1)

          expected = f"v{version}"
          if tag != expected:
            print(f"ERROR: Tag '{tag}' does not match Cargo.toml version '{version}' (expected '{expected}')", file=sys.stderr)
            sys.exit(1)
          print(f"OK: {tag} matches Cargo.toml version {version}")
          PY
        env:
          TAG: ${{ steps.tag.outputs.tag }}

      - name: Generate release notes (git-cliff)
        id: git-cliff
        uses: orhun/git-cliff-action@v4
        with:
          config: git-cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: RELEASE_NOTES.md
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body: ${{ steps.git-cliff.outputs.content }}

  build:
    name: Build & Upload Binaries
    needs: release
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release --locked

      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BIN="envgen"
          ASSET="envgen-${{ needs.release.outputs.tag }}-${{ runner.os }}-${{ runner.arch }}.tar.gz"
          tar -czf "$ASSET" -C target/release "$BIN"
          echo "ASSET=$ASSET" >> "$GITHUB_ENV"
          echo "ASSET_PATH=$ASSET" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $bin = "envgen.exe"
          $asset = "envgen-${{ needs.release.outputs.tag }}-${{ runner.os }}-${{ runner.arch }}.zip"
          Compress-Archive -Path "target/release/$bin" -DestinationPath $asset -Force
          "ASSET=$asset" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ASSET_PATH=$asset" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload release asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.release.outputs.tag }}
          file: ${{ env.ASSET_PATH }}
          asset_name: ${{ env.ASSET }}
          overwrite: true

