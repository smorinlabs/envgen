name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (e.g. v0.1.0)"
        required: true
        type: string

concurrency:
  group: release-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref_name }}-${{ inputs.tag || 'none' }}
  cancel-in-progress: false

jobs:
  meta:
    name: Resolve tag + validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          ref: ${{ steps.tag.outputs.tag }}

      - name: Validate tag matches Cargo.toml version
        shell: bash
        run: |
          python - <<'PY'
          import os
          import re
          import sys
          try:
            import tomllib  # py3.11+
          except ModuleNotFoundError:
            print("ERROR: Python tomllib not available", file=sys.stderr)
            sys.exit(1)

          tag = os.environ.get("TAG")
          if not tag:
            print("ERROR: TAG env var not set", file=sys.stderr)
            sys.exit(1)
          if not re.match(r"^v\\d+\\.\\d+\\.\\d+.*$", tag):
            print(f"ERROR: tag '{tag}' does not look like vX.Y.Z", file=sys.stderr)
            sys.exit(1)

          with open("Cargo.toml", "rb") as f:
            cargo = tomllib.load(f)
          version = cargo.get("package", {}).get("version")
          if not version:
            print("ERROR: Could not find [package].version in Cargo.toml", file=sys.stderr)
            sys.exit(1)

          expected = f"v{version}"
          if tag != expected:
            print(f"ERROR: Tag '{tag}' does not match Cargo.toml version '{version}' (expected '{expected}')", file=sys.stderr)
            sys.exit(1)
          print(f"OK: {tag} matches Cargo.toml version {version}")
          PY
        env:
          TAG: ${{ steps.tag.outputs.tag }}

      - name: Extract version
        id: version
        shell: bash
        run: |
          VERSION="$(python - <<'PY'
          import sys
          try:
            import tomllib  # py3.11+
          except ModuleNotFoundError:
            print("ERROR: Python tomllib not available", file=sys.stderr)
            sys.exit(1)
          with open("Cargo.toml", "rb") as f:
            cargo = tomllib.load(f)
          version = cargo.get("package", {}).get("version")
          if not version:
            print("ERROR: Could not find [package].version in Cargo.toml", file=sys.stderr)
            sys.exit(1)
          print(version)
          PY
          )"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  verify:
    name: Verify (${{ matrix.os }})
    needs: meta
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ needs.meta.outputs.tag }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Setup Go
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: "1.22.x"

      - name: Setup Node
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20.x"

      - name: Setup uv
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: astral-sh/setup-uv@caf0cab7a618c569241d31dcd442f54681755d39 # v3

      - name: Install yamlfmt
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          go install github.com/google/yamlfmt/cmd/yamlfmt@v0.15.0
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Run checks (Linux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        env:
          UV_CACHE_DIR: ${{ github.workspace }}/.uv-cache
          UV_TOOL_DIR: ${{ github.workspace }}/.uv-tools
        run: make check

      - name: Rust checks (macOS)
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          cargo fmt --check
          cargo clippy -- -D warnings
          cargo test --locked

  publish-crates:
    name: Publish to crates.io
    needs: [meta, verify]
    runs-on: ubuntu-latest
    environment: crates-io
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ needs.meta.outputs.tag }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Authenticate with crates.io (trusted publishing)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1

      - name: Verify publish payload (dry run)
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: cargo publish --dry-run --locked

      - name: Publish
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: |
          set -euo pipefail
          if [[ -z "${CARGO_REGISTRY_TOKEN:-}" ]]; then
            echo "ERROR: missing temporary crates.io token from trusted publishing"
            exit 1
          fi

          cargo publish --locked 2>publish.err || {
            if grep -q "already uploaded" publish.err; then
              echo "crate already published; skipping"
              exit 0
            fi
            cat publish.err >&2
            exit 1
          }

  github-release:
    name: Create GitHub Release
    needs: [meta, verify]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          ref: ${{ needs.meta.outputs.tag }}

      - name: Generate release notes (git-cliff)
        id: git-cliff
        uses: orhun/git-cliff-action@e16f179f0be49ecdfe63753837f20b9531642772 # v4
        with:
          config: git-cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: RELEASE_NOTES.md
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ needs.meta.outputs.tag }}
          name: ${{ needs.meta.outputs.tag }}
          body: ${{ steps.git-cliff.outputs.content }}

  build:
    name: Build & Upload Binaries
    needs: [meta, github-release]
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ needs.meta.outputs.tag }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Build
        run: cargo build --release --locked

      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BIN="envgen"
          ASSET="envgen-${{ needs.meta.outputs.tag }}-${{ runner.os }}-${{ runner.arch }}.tar.gz"
          tar -czf "$ASSET" -C target/release "$BIN"
          echo "ASSET=$ASSET" >> "$GITHUB_ENV"
          echo "ASSET_PATH=$ASSET" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $bin = "envgen.exe"
          $asset = "envgen-${{ needs.meta.outputs.tag }}-${{ runner.os }}-${{ runner.arch }}.zip"
          Compress-Archive -Path "target/release/$bin" -DestinationPath $asset -Force
          "ASSET=$asset" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ASSET_PATH=$asset" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload release asset
        uses: svenstaro/upload-release-action@6b7fa9f267e90b50a19fef07b3596790bb941741 # v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.meta.outputs.tag }}
          file: ${{ env.ASSET_PATH }}
          asset_name: ${{ env.ASSET }}
          overwrite: true

  homebrew-core:
    name: Open homebrew-core bump PR
    needs: [meta, verify, publish-crates]
    runs-on: macos-latest
    permissions:
      contents: read
    env:
      HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }}
    steps:
      - name: Brew update
        if: ${{ env.HOMEBREW_GITHUB_API_TOKEN != '' }}
        run: brew update

      - name: Check formula exists
        id: formula
        shell: bash
        if: ${{ env.HOMEBREW_GITHUB_API_TOKEN != '' }}
        run: |
          if brew info envgen >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump formula PR
        if: ${{ env.HOMEBREW_GITHUB_API_TOKEN != '' && steps.formula.outputs.exists == 'true' }}
        run: |
          brew bump-formula-pr \
            --tag "${{ needs.meta.outputs.tag }}" \
            --version "${{ needs.meta.outputs.version }}" \
            --no-browse \
            --no-audit \
            envgen
