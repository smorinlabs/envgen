name: Publish Fallback (Token)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing release tag to publish (e.g. v0.1.0)"
        required: true
        type: string

concurrency:
  group: publish-fallback-${{ inputs.tag }}
  cancel-in-progress: false

jobs:
  publish:
    name: Publish to crates.io via token fallback
    runs-on: ubuntu-latest
    environment: crates-io
    permissions:
      contents: read
    steps:
      - name: Checkout tag
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.tag }}

      - name: Validate tag matches Cargo.toml version
        shell: bash
        env:
          TAG: ${{ inputs.tag }}
        run: |
          python - <<'PY'
          import os
          import re
          import sys
          try:
            import tomllib
          except ModuleNotFoundError:
            print("ERROR: Python tomllib not available", file=sys.stderr)
            sys.exit(1)

          tag = os.environ.get("TAG")
          if not tag:
            print("ERROR: TAG env var not set", file=sys.stderr)
            sys.exit(1)
          if not re.match(r"^v\\d+\\.\\d+\\.\\d+.*$", tag):
            print(f"ERROR: tag '{tag}' does not look like vX.Y.Z", file=sys.stderr)
            sys.exit(1)

          with open("Cargo.toml", "rb") as f:
            cargo = tomllib.load(f)
          version = cargo.get("package", {}).get("version")
          if not version:
            print("ERROR: Could not find [package].version in Cargo.toml", file=sys.stderr)
            sys.exit(1)

          expected = f"v{version}"
          if tag != expected:
            print(f"ERROR: Tag '{tag}' does not match Cargo.toml version '{version}' (expected '{expected}')", file=sys.stderr)
            sys.exit(1)

          print(f"OK: {tag} matches Cargo.toml version {version}")
          PY

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Verify publish payload (dry run)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --dry-run --locked

      - name: Publish
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${CARGO_REGISTRY_TOKEN:-}" ]]; then
            echo "ERROR: missing CARGO_REGISTRY_TOKEN secret"
            exit 1
          fi

          cargo publish --locked 2>publish.err || {
            if grep -q "already uploaded" publish.err; then
              echo "crate already published; skipping"
              exit 0
            fi
            cat publish.err >&2
            exit 1
          }
